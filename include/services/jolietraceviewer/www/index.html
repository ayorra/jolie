<html>
    <head>
        
            <link rel="stylesheet" type="text/css" href="DataTables/datatables.min.css"/>
            <link rel="stylesheet" type="text/css" href="css/jtv.css"/>
            <script type="text/javascript" src="js/jquery-3.4.1.min.js"></script>
            <script type="text/javascript" src="DataTables/datatables.min.js"></script>
            <script type="text/javascript" src="js/jolie-client.js"></script>
            
    </head>
    <script>
        function onError( data ) {
            alert( error )
        }

        function refreshTraceList() {
            JolieClient.getTraceList({}, function( data ) {
                for( i = 0; i < data.trace.length; i++ ) {
                    var logName = data.trace[i].substring(0,2) + "/" + data.trace[i].substring(2,4) + "/" 
                        + data.trace[i].substring(4,8) + " " + data.trace[i].substring(8,10) + ":" + data.trace[i].substring(10,12) + ":"
                        + data.trace[i].substring(12,14) 
                    $(".menutd").append("<table width='100%'><tr><td class='itemmenu'><a onclick='getTrace(\"" + data.trace[i] + "\")'>" + logName +  "</a></td></tr></table>")
                }
            }, onError )
        }

        function formatCode( code, line ) {
            var lines = code.split(/\n/);
            var returnHtml = "<table class='code'>";
            for( var i = 0; i < lines.length; i++ ) {

                var linenumber = i + 1
                if ( linenumber == line ) {
                    highlightedline = "class='highlightedline'"
                } else {
                    highlightedline = ""
                }
                returnHtml = returnHtml + "<tr><td class='line'>" + linenumber + "</td><td "  + highlightedline + ">" + lines[i].replace(/ /g,"&nbsp") + "</td></tr>"
            }
            returnHtml = returnHtml + "</table>"
            return returnHtml;
        }

        function showCode( file, line ) {
            JolieClient.getServiceFile( {"$": file }, function( data ) {
                $( "#content" ).empty().html( formatCode( data.$, line ) );
                $("#message").show()
            }, onError)
            
        }


        function showMessage( el, message ) {
            $( "#content" ).empty().html( atob( message ).replace(/\n/g,"<br>").replace(/\t/g,"&nbsp;") );
            $("#message").show()
        }

        function getTrace( trace ) {
            
            JolieClient.getTrace({ "$": trace }, function( data ) {
                $("#bodytd").empty().append("<table id='traceTable'><thead><tr><th>Index</th><th>Timestamp</th><th>Service</th><th>Code Line</th><th>Action Type</th><th>Action</th><th>Description</th><th>MsgId</th><th>Message</th></tr></thead></table>")
                var table = $("#traceTable").DataTable({
                        "columnDefs": [
                            { "width": "5%", "targets": 0 },
                            { "width": "20%","targets": 1 },
                            { "width": "10%", "targets": 3 },
                            { "className":"text-right", "targets": 3 },
                            { "width": "5%", "targets": 4 },
                            { "width": "5%", "targets": 6 },
                            { "className":"text-right", "targets": 7 }
                        ]
                        });   
                var lines = data.$.split(/\n/);
                for( var i = 0; i < lines.length; i++ ) {
                    try {
                        var obj = JSON.parse( lines[ i ] );
                        var key = Object.keys( obj )[0];
                        if ( obj[ key ].length == 7 ) {
                            table.row.add([
                                key,
                                obj[ key ][0],
                                obj[ key ][2],
                                obj[ key ][3],
                                obj[ key ][4],
                                obj[ key ][5],
                                obj[ key ][6],
                                "",
                                ""

                            ])
                        }
                        if ( obj[ key ].length == 9 ) {
                            table.row.add([
                                key,
                                obj[ key ][0],
                                obj[ key ][2].split('/').pop(),
                                obj[ key ][3] + "&nbsp;<button onclick='showCode(\"" + obj[ key ][2] + "\"," + obj[ key ][3] + ")'>view</button>",
                                obj[ key ][4],
                                obj[ key ][5],
                                obj[ key ][6],
                                obj[ key ][7],
                                "<button onclick='showMessage(this, \"" + obj[ key ][8] + "\")'>Show Message</button><div style='display:none;'>" 
                                    + atob( obj[ key ][8] ) + "</div>"
                            ])
                        }
                    } catch (e) {}
                    
                }
                table.draw();
            }, onError )
        }
    </script>
    </script>
    <body>
        <div id="message">
            <button onclick="$('#message').hide()">Close</button>
            <div id='content'>

            </div>
        </div>
        <table class='headertable'><tr><td>Jolie Trace Viewer</td></tr></table>
        <table class='maintable'>
            <tr>
                <td  valign='top' class='menutd'>
                </td>
                <td valign='top' id='bodytd'  class='bodytd'></td>
            </tr>
        </table>
    </body>
    <script>
        refreshTraceList()
    </script>
</html>